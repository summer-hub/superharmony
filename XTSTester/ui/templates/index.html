<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTSRunner - Web控制台</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .progress-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s, background-color 0.5s;
        }
        
        .progress-fill.inactive {
            background-color: #a0a0a0;
        }
        
        .log-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #2b2b2b;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        .log-line {
            margin: 0;
            padding: 2px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .log-controls-buttons {
            display: flex;
            gap: 10px;
        }
        .log-controls button {
            background-color: #007bff;
            padding: 5px 10px;
            font-size: 12px;
        }
        .log-controls button:hover {
            background-color: #0056b3;
        }
        .log-controls button#clear-log-btn {
            background-color: #dc3545;
        }
        
        .log-controls button#clear-log-btn:hover {
            background-color: #c82333;
        }
        .auto-scroll-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        /* 确保按钮与下拉菜单高度一致 */
        .button-group button {
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>XTSRunner - Web控制台</h1>
        
        <div class="control-panel">
            <div class="form-group">
                <label for="repo-type">仓库组:</label>
                <select id="repo-type">
                    <option value="openharmony-sig">openharmony-sig</option>
                    <option value="openharmony-tpc">openharmony-tpc</option>
                    <option value="openharmony_tpc_samples">openharmony_tpc_samples</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sdk-version">SDK版本:</label>
                <select id="sdk-version">
                    <option value="5.0.0">5.0.0</option>
                    <option value="5.0.1">5.0.1</option>
                    <option value="5.0.2">5.0.2</option>
                    <option value="5.0.3">5.0.3</option>
                    <option value="5.0.4" selected>5.0.4</option>
                    <option value="5.1.0">5.1.0</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="release-mode">编译模式:</label>
                <select id="release-mode">
                    <option value="n">Debug模式</option>
                    <option value="y">Release模式</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="test-control">测试控制:</label>
                <div class="button-group">
                    <button id="start-btn">开始测试</button>
                    <button id="stop-btn" style="background-color: #f44336; display: none;">停止测试</button>
                </div>
            </div>
        </div>
        
        <div id="status-panel" class="status-panel" style="display: none;">
            <h3>测试状态</h3>
            <p><strong>仓库组:</strong> <span id="status-repo-type">-</span></p>
            <p><strong>进度:</strong> <span id="status-progress">0/0</span></p>
            <p><strong>当前库:</strong> <span id="status-current-lib">-</span></p>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="log-controls">
            <div class="auto-scroll-toggle">
                <input type="checkbox" id="auto-scroll" checked>
                <label for="auto-scroll">自动滚动日志</label>
            </div>
            <div class="log-controls-buttons">
                <button id="clear-log-btn">清理日志</button>
                <button id="download-log-btn">下载日志</button>
            </div>
        </div>
        
        <div id="log-container" class="log-container">
            <p class="log-line">等待测试开始...</p>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusPanel = document.getElementById('status-panel');
            const statusRepoType = document.getElementById('status-repo-type');
            const statusProgress = document.getElementById('status-progress');
            const statusCurrentLib = document.getElementById('status-current-lib');
            const progressFill = document.getElementById('progress-fill');
            const logContainer = document.getElementById('log-container');
            const autoScrollCheckbox = document.getElementById('auto-scroll');
            const downloadLogBtn = document.getElementById('download-log-btn');
            const clearLogBtn = document.getElementById('clear-log-btn');
            
            let isRunning = false;
            let statusCheckInterval;
            let userScrolled = false;
            
            // 监听日志容器的滚动事件
            logContainer.addEventListener('scroll', function() {
                // 如果用户手动滚动，记录状态
                if (autoScrollCheckbox.checked) {
                    const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 5;
                    userScrolled = !isScrolledToBottom;
                }
            });
            
            // 下载日志
            downloadLogBtn.addEventListener('click', function() {
                const logText = Array.from(logContainer.querySelectorAll('.log-line'))
                    .map(line => line.textContent)
                    .join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test_log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // 清理日志
            clearLogBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有日志吗？')) {
                    logContainer.innerHTML = '<p class="log-line">日志已清空...</p>';
                    userScrolled = false;  // 重置滚动状态
                }
            });
            
            // 开始测试
            startBtn.addEventListener('click', function() {
                if (isRunning) return;
                
                const repoType = document.getElementById('repo-type').value;
                const sdkVersion = document.getElementById('sdk-version').value;
                const releaseMode = document.getElementById('release-mode').value;
                
                // 清空日志
                logContainer.innerHTML = '<p class="log-line">正在启动测试...</p>';
                userScrolled = false;  // 重置滚动状态
                
                // 确保进度条是绿色
                progressFill.classList.remove('inactive');
                
                // 发送请求
                fetch('/api/start_test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repo_type: repoType,
                        sdk_version: sdkVersion,
                        release_mode: releaseMode
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isRunning = true;
                        startBtn.disabled = true;
                        stopBtn.style.display = 'inline-block';  // 显示停止按钮
                        statusPanel.style.display = 'block';
                        statusRepoType.textContent = repoType;
                        
                        // 开始定时检查状态
                        statusCheckInterval = setInterval(checkStatus, 1000);
                    } else {
                        logContainer.innerHTML += `<p class="log-line" style="color: red;">${data.message}</p>`;
                    }
                })
                .catch(error => {
                    logContainer.innerHTML += `<p class="log-line" style="color: red;">请求失败: ${error}</p>`;
                });
            });
            
            // 停止测试
            stopBtn.addEventListener('click', function() {
                if (!isRunning) return;
                
                // 添加确认对话框
                if (!confirm('确定要停止当前测试吗？这将中断所有正在进行的测试过程。')) {
                    return;
                }
                
                // 将进度条变为灰色
                progressFill.classList.add('inactive');
                
                // 发送停止请求
                fetch('/api/stop_test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    logContainer.innerHTML += `<p class="log-line" style="${data.status === 'success' ? 'color: orange; font-weight: bold;' : 'color: red;'}">${data.message}</p>`;
                    
                    if (data.status === 'success' || data.status === 'warning') {
                        // 重置UI状态
                        isRunning = false;
                        startBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        clearInterval(statusCheckInterval);
                    }
                })
                .catch(error => {
                    logContainer.innerHTML += `<p class="log-line" style="color: red;">停止请求失败: ${error}</p>`;
                });
            });
            
            // 检查测试状态
            function checkStatus() {
                fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.running) {
                        // 确保进度条是绿色（如果之前被设置为灰色）
                        progressFill.classList.remove('inactive');
                        
                        // 更新状态
                        statusProgress.textContent = `${data.progress}/${data.total}`;
                        statusCurrentLib.textContent = data.current_lib || '-';
                        
                        // 更新进度条
                        if (data.total > 0) {
                            const percent = (data.progress / data.total) * 100;
                            progressFill.style.width = `${percent}%`;
                        }
                        
                        // 更新日志
                        if (data.logs && data.logs.length > 0) {
                            logContainer.innerHTML = '';
                            data.logs.forEach(log => {
                                const logLine = document.createElement('p');
                                logLine.className = 'log-line';
                                logLine.textContent = log;
                                logContainer.appendChild(logLine);
                            });
                            
                            // 只有当自动滚动选项开启且用户没有主动滚动时，才滚动到底部
                            if (autoScrollCheckbox.checked && !userScrolled) {
                                logContainer.scrollTop = logContainer.scrollHeight;
                            }
                        }
                    } else if (isRunning) {
                        // 测试已结束
                        isRunning = false;
                        startBtn.disabled = false;
                        stopBtn.style.display = 'none';  // 隐藏停止按钮
                        clearInterval(statusCheckInterval);
                        
                        // 将进度条变为灰色
                        progressFill.classList.add('inactive');
                        
                        // 更新日志以显示最新状态
                        if (data.logs && data.logs.length > 0) {
                            logContainer.innerHTML = '';
                            data.logs.forEach(log => {
                                const logLine = document.createElement('p');
                                logLine.className = 'log-line';
                                
                                // 为特定消息添加颜色
                                if (log.includes("测试和报告生成已完成") || log.includes("测试进程已结束") || log.includes("PASS")) {
                                    logLine.style.color = "green";
                                    logLine.style.fontWeight = "bold";
                                } else if (log.includes("测试已被用户中断")) {
                                    logLine.style.color = "orange";
                                    logLine.style.fontWeight = "bold";
                                } else if (log.includes("FAIL") || log.includes("ERROR")) {
                                    logLine.style.color = "red";
                                }
                                
                                logLine.textContent = log;
                                logContainer.appendChild(logLine);
                            });
                            
                            // 测试结束后，如果自动滚动开启，滚动到底部显示完成消息
                            if (autoScrollCheckbox.checked) {
                                logContainer.scrollTop = logContainer.scrollHeight;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                });
            }
        });
    </script>
</body>
</html>